upstream management {
    server management-service:80;
}

upstream identity {
    server identity-service:80;
}

upstream storage {
    server storage-service:80;
}

upstream angular {
    server angular:8080;
}

upstream doc-portal {
    server doc-portal:8080;
}

server {
    listen 8989;
    server_name localhost;
    error_log /var/log/nginx/error.log debug;
    
    location /api/management/identity/ {
        rewrite ^/api/management/(.*) /$1  break;
        proxy_pass          http://identity/;
        proxy_set_header    Host                $host;
        proxy_set_header    X-Real-IP           $remote_addr;
        proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;            
    }

    location /api/management/users/ {
        rewrite ^/api/management/(.*) /$1  break;
        proxy_pass          http://management/;
        proxy_set_header    Host                $host;
        proxy_set_header    X-Real-IP           $remote_addr;
        proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;            
    }

    location /api/management/organizations/ {
        rewrite ^/api/management/(.*) /$1  break;
        proxy_pass          http://management/;
        proxy_set_header    Host                $host;
        proxy_set_header    X-Real-IP           $remote_addr;
        proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;            
    }

    location /api/management/ {
        rewrite ^/api/management/(.*) /$1  break;
        proxy_pass          http://identity/;
        proxy_set_header    Host                $host;
        proxy_set_header    X-Real-IP           $remote_addr;
        proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;            
    }

    location /api/storage/ {
        rewrite ^/api/storage/(.*) /$1  break;
        proxy_pass          http://storage/;
        proxy_set_header    Host                $host;
        proxy_set_header    X-Real-IP           $remote_addr;
        proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
    }

    location /api/identity/ {
        rewrite ^/(.*) /$1  break;
        proxy_pass          http://identity/;
        proxy_set_header    Host                $host;
        proxy_set_header    X-Real-IP           $remote_addr;
        proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
    }

    location /api/ {
        rewrite ^/(.*) /$1  break;
        proxy_pass          http://doc-portal/;
        proxy_set_header    Host                $host;
        proxy_set_header    X-Real-IP           $remote_addr;
        proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
    }

    location / {
        rewrite ^/(.*) /$1  break;
        proxy_pass          http://angular;
        proxy_set_header    Host                $host;
        proxy_set_header    X-Real-IP           $remote_addr;
        proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
    }
}